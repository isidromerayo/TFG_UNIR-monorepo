name: Update Submodules

on:
  # Trigger manual
  workflow_dispatch:
  
  # Trigger desde otros repos
  repository_dispatch:
    types: [submodule-updated]
  
  # Trigger programado (cada 6 horas)
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  
  # Trigger cuando se hace push a main (para verificar)
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    
    # Permite que el workflow haga un push al repositorio
    permissions:
      contents: write

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3
        with:
          # Necesitamos el token aqu√≠ para poder hacer push
          token: ${{ secrets.GITHUB_TOKEN }}
          # Inicializa los subm√≥dulos durante el checkout
          submodules: 'true'

      - name: Check current submodule status
        run: |
          echo "üìä Current submodule status:"
          git submodule status
          echo ""
          echo "üîç Checking for updates..."

      - name: Update all submodules to the latest commit
        run: |
          # Intentar actualizar con merge primero
          if ! git submodule update --remote --merge; then
            echo "‚ö†Ô∏è Merge failed, trying with rebase strategy..."
            # Si falla, intentar con rebase
            if ! git submodule update --remote --rebase; then
              echo "‚ö†Ô∏è Rebase failed, using checkout strategy (will detach HEAD)..."
              # Si tambi√©n falla, usar checkout directo (esto siempre funciona)
              git submodule update --remote
            fi
          fi
          echo ""
          echo "üìä Updated submodule status:"
          git submodule status

      - name: Check for changes
        id: check_changes
        run: |
          # A√±adir los cambios de subm√≥dulos al staging area
          git add -A
          
          if ! git diff-index --quiet --cached HEAD; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Submodule updates detected"
            echo ""
            echo "üìù Changes to be committed:"
            git diff --cached --name-status
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No submodule changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # Crear mensaje de commit con lista de subm√≥dulos actualizados
          SUBMODULES=$(git diff --cached --name-only | grep -E '^(angular|backend|react|vue3)/' | cut -d'/' -f1 | sort -u | paste -sd ", " -)
          
          if [ -n "$SUBMODULES" ]; then
            COMMIT_MSG="chore: auto-update submodules to latest versions

Updated: $SUBMODULES

[skip ci]"
          else
            COMMIT_MSG="chore: auto-update submodules to latest versions

[skip ci]"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "‚úÖ Submodules updated and pushed successfully"
      
      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "‚ÑπÔ∏è All submodules are already up to date"
