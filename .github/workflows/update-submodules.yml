name: Update Submodules

on:
  # Trigger manual
  workflow_dispatch:
  
  # Trigger desde otros repos
  repository_dispatch:
    types: [submodule-updated]
  
  # Trigger programado (cada 6 horas)
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  
  # Trigger cuando se hace push a main (para verificar)
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    
    # Permite que el workflow haga un push al repositorio
    permissions:
      contents: write

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3
        with:
          # Necesitamos el token aqu√≠ para poder hacer push
          token: ${{ secrets.GITHUB_TOKEN }}
          # Inicializa los subm√≥dulos durante el checkout
          submodules: 'true'

      - name: Check current submodule status
        run: |
          echo "üìä Current submodule status:"
          git submodule status
          echo ""
          echo "üîç Checking for updates..."

      - name: Update all submodules to the latest commit
        run: |
          # Actualizar cada subm√≥dulo individualmente para mejor control
          for submodule in angular backend react vue3; do
            if [ -d "$submodule" ]; then
              echo "üîÑ Updating $submodule..."
              cd "$submodule"
              
              # Obtener la rama configurada para el subm√≥dulo
              BRANCH=$(git config -f ../.gitmodules submodule.$submodule.branch || echo "main")
              
              # Fetch los √∫ltimos cambios
              git fetch origin
              
              # Checkout a la rama y pull
              if git checkout "$BRANCH" 2>/dev/null; then
                git pull origin "$BRANCH" --ff-only || git reset --hard origin/"$BRANCH"
                echo "‚úÖ $submodule updated to latest $BRANCH"
              else
                # Si no existe la rama localmente, hacer checkout desde origin
                git checkout -B "$BRANCH" origin/"$BRANCH"
                echo "‚úÖ $submodule checked out to $BRANCH"
              fi
              
              cd ..
            fi
          done
          
          echo ""
          echo "üìä Updated submodule status:"
          git submodule status

      - name: Check for changes
        id: check_changes
        run: |
          # A√±adir los cambios de subm√≥dulos al staging area
          git add -A
          
          if ! git diff-index --quiet --cached HEAD; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Submodule updates detected"
            echo ""
            echo "üìù Changes to be committed:"
            git diff --cached --name-status
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No submodule changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # Crear mensaje de commit con lista de subm√≥dulos actualizados
          SUBMODULES=$(git diff --cached --name-only | grep -E '^(angular|backend|react|vue3)/' | cut -d'/' -f1 | sort -u | paste -sd ", " -)
          
          if [ -n "$SUBMODULES" ]; then
            git commit -m "chore: auto-update submodules to latest versions" -m "Updated: $SUBMODULES" -m "[skip ci]"
          else
            git commit -m "chore: auto-update submodules to latest versions" -m "[skip ci]"
          fi
          
          git push
          
          echo "‚úÖ Submodules updated and pushed successfully"
      
      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "‚ÑπÔ∏è All submodules are already up to date"
