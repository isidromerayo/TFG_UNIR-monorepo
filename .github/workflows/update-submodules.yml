name: Update Submodules

on:
  # Trigger manual
  workflow_dispatch:
  
  # Trigger desde otros repos
  repository_dispatch:
    types: [submodule-updated]
  
  # Trigger programado (cada 6 horas)
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas
  
  # Trigger cuando se hace push a main (para verificar)
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    
    # Permite que el workflow haga un push al repositorio
    permissions:
      contents: write

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3
        with:
          # Necesitamos el token aqu√≠ para poder hacer push
          token: ${{ secrets.GITHUB_TOKEN }}
          # Inicializa los subm√≥dulos durante el checkout
          submodules: 'true'

      - name: Check current submodule status
        run: |
          echo "üìä Current submodule status:"
          git submodule status
          echo ""
          echo "üîç Checking for updates..."

      - name: Update all submodules to the latest commit
        run: |
          git submodule update --remote --merge
          echo ""
          echo "üìä Updated submodule status:"
          git submodule status

      - name: Check for changes
        id: check_changes
        run: |
          if ! git diff-index --quiet HEAD; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Submodule updates detected"
            git status
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No submodule changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # Crear mensaje de commit detallado
          COMMIT_MSG="chore: auto-update submodules to latest versions"
          echo "" >> commit_msg.txt
          echo "$COMMIT_MSG" >> commit_msg.txt
          echo "" >> commit_msg.txt
          echo "Updated submodules:" >> commit_msg.txt
          git diff --cached --name-only >> commit_msg.txt
          
          git commit -F commit_msg.txt
          git push
          
          echo "‚úÖ Submodules updated and pushed successfully"
      
      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "‚ÑπÔ∏è All submodules are already up to date"
